---
 - hosts: pgaserver
   remote_user: normaluser
   become: yes
   become_method: sudo
   become_user: root
   gather_facts: yes
   connection: ssh

   tasks:
           - name: Update the server
             shell: |
                     apt-get update
             args:
                     warn: false

           - name: Install wget, sudo, curl, tcpdump, net-tools, vim, iputils-ping, python2
             apt:
                     name: "{{item}}"
                     state: present
             loop:
                     - wget
                     - sudo
                     - curl
                     - tcpdump
                     - net-tools
                     - vim
                     - iputils-ping
                     - python2

           - name: Getting the node-exporter package
             shell: |
                     wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz
                     tar -xzf alertmanager-0.25.0.linux-amd64.tar.gz
                     sudo useradd -s /sbin/nologin prometheus
                     chmod 755 alertmanager-0.25.0.linux-amd64 -R
                     chown prometheus:prometheus alertmanager-0.25.0.linux-amd64 -R
             args:
                     warn: false

           - name: Taking backup of default alertmanager configuration
             copy:
                     src: /home/normaluser/alertmanager-0.25.0.linux-amd64/alertmanager.yml
                     dest: /home/normaluser/alertmanager-0.25.0.linux-amd64/alertmanager.yml_orig
                     remote_src: yes

           - name: Copying prometheus configuration file
             copy:
                     src: conf/alertmanager.yml
                     dest: /home/normaluser/alertmanager-0.25.0.linux-amd64/alertmanager.yml

           - name: Copying alertmanager.service file
             copy:
                     src: conf/alertmanager.service
                     dest: /etc/systemd/system/alertmanager.service

           - name: Copying systemctl file
             copy:
                     src: conf/systemctl.py
                     dest: /usr/bin/systemctl

           - name: Running some extra steps
             shell: |
                     chmod 755 /usr/bin/systemctl
                     sudo systemctl daemon-reload
             args:
                     warn: false


           - name: Starting the alertmanager service
             service:
                     name: alertmanager
                     state: started

